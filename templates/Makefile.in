# convenience Makefile to run validation tests
# src: source path discovered in run time
# minimum_test_coverage: minimun test coverage allowed
# pep8_ignore: ignore listed PEP 8 errors and warnings
# max_complexity: maximum McCabe complexity allowed
# csslint_ignore: skip file names matching find pattern (use ! -name PATTERN)
# jshint_ignore: skip file names matching find pattern (use ! -name PATTERN)

SHELL = /bin/bash

src = `find . -type d | grep -m 1 "${variables:source}"`
minimum_test_coverage = ${buildout:package-minimum-test-coverage}
pep8_ignore = ${buildout:package-pep8-ignore}
max_complexity = ${buildout:package-max-complexity}
csslint_ignore = ${buildout:package-csslint-ignore}
jshint_ignore = ${buildout:package-jshint-ignore}

NO_COLOR = \x1b[0m
OK_COLOR = \x1b[32;01m
ERROR_COLOR = \x1b[31;01m
WARN_COLOR = \x1b[33;01m

OK_STRING = $(OK_COLOR)[ok]$(NO_COLOR)
ERROR_STRING = $(ERROR_COLOR)[errors]$(NO_COLOR)
WARN_STRING = $(WARN_COLOR)[warnings]$(NO_COLOR)

python-validation:
	bin/flake8 --ignore=$(pep8_ignore) --max-complexity=$(max_complexity) $(src)

css-validation:
	npm install csslint -g 2>/dev/null
	find $(src) -type f -name *.css $(csslint_ignore) | xargs csslint

js-validation:
	npm install jshint -g 2>/dev/null
	find $(src) -type f -name *.js $(jshint_ignore) | xargs jshint

coverage-validation:
	bin/coverage.sh $(minimum_test_coverage)

zpt-validation:
	find $(src) -type f -name *.pt | xargs ${buildout:directory}/bin/zptlint

i18n-validation:
	bin/i18ndude find-untranslated -n $(src)
